<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/registro.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <title>Admin - Crear Usuario</title>
</head>
<body>
    <header class="navbar">
        <div class="logo">
            <img src="../img/pasteleria-logo.svg" alt="">
        </div>
        <nav>
            <ul>
                <li><a href="administrador.html">Home Admin</a></li>
                <li><a href="producto.html">Productos</a></li>
                <li><a href="usuario.html">Usuarios</a></li>
                <li><a href="../index.html">Salir</a></li>
            </ul>
        </nav>
        <div class="carro" id="carro-btn" tabindex="0"></div>
    </header>
    <main>
        <section class="form-container">
            <h1>Crear Usuario Nuevo</h1>
            <form id="formUsuarioNuevo">
                <label for="run">RUN</label>
                <input type="text" id="run" required maxlength="12">

                <label for="nombre">Nombre</label>
                <input type="text" id="nombre" required maxlength="50">

                <label for="apellidos">Apellidos</label>
                <input type="text" id="apellidos" required maxlength="80">

                <label for="correo">Correo</label>
                <input type="email" id="correo" required maxlength="100">

                <label for="password">Contraseña</label>
                <input type="password" id="password" required minlength="4" maxlength="10">

                <label for="direccion">Dirección</label>
                <input type="text" id="direccion" required maxlength="100">

                <label for="region">Región</label>
                <select id="region" required>
                    <option value="">Seleccione una región</option>
                </select>

                <label for="comuna">Comuna</label>
                <select id="comuna" required>
                    <option value="">Seleccione una comuna</option>
                </select>

                <label for="fechaNac">Fecha de Nacimiento</label>
                <input type="date" id="fechaNac" required>

                <label for="codigo">Código de descuento (opcional)</label>
                <input type="text" id="codigo" maxlength="30">

                <button type="submit">Crear Usuario</button>
            </form>
            <p id="usuario-creado" style="display:none;color:green;text-align:center;margin-top:10px;">¡Usuario creado exitosamente!</p>
        </section>
    </main>
    <script src="../js/region-comuna.js"></script>
    <script>
    // Guardar usuario nuevo en localStorage (igual que registro.js)
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formUsuarioNuevo');
        const mensaje = document.getElementById('usuario-creado');
        if (!form) return;

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const run = document.getElementById('run').value;
            const nombre = document.getElementById('nombre').value;
            const apellidos = document.getElementById('apellidos').value;
            const correo = document.getElementById('correo').value;
            const password = document.getElementById('password').value;
            const direccion = document.getElementById('direccion').value;
            const region = document.getElementById('region').value;
            const comuna = document.getElementById('comuna').value;
            const fechaNac = document.getElementById('fechaNac').value;
            const codigo = document.getElementById('codigo').value.trim();

            // Calcular edad
            let edad = 0;
            if (fechaNac) {
                const hoy = new Date();
                const cumple = new Date(fechaNac);
                edad = hoy.getFullYear() - cumple.getFullYear();
                const m = hoy.getMonth() - cumple.getMonth();
                if (m < 0 || (m === 0 && hoy.getDate() < cumple.getDate())) {
                    edad--;
                }
            }

            // Determinar beneficios
            let beneficios = {};
            if (edad > 50) {
                beneficios.descuento = 0.5; // 50%
            }
            if (codigo.toUpperCase() === "FELICES50") {
                beneficios.descuento = Math.max(beneficios.descuento || 0, 0.1); // 10% (o 50% si ya lo tiene)
                beneficios.descuentoFijo = true;
            }
            if (correo.endsWith("@duocuc.cl")) {
                beneficios.tortaGratisCumple = true;
            }

            const usuario = {
                run,
                nombre,
                apellidos,
                correo,
                password,
                direccion,
                region,
                comuna,
                fechaNac,
                edad,
                beneficios
            };

            let usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
            usuarios.push(usuario);
            localStorage.setItem('usuarios', JSON.stringify(usuarios));

            mensaje.style.display = "block";
            form.reset();
            setTimeout(() => {
                window.location.href = "usuario.html";
            }, 1200);
        });
    });
    </script>
</body>
</html>